{% extends 'admin/custom_change_list.html' %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
{{ block.super }}
<style>
    label,
    select,
    option,
    .button {
        font-size: small !important;
        font-family: var(--font-family-primary);
    }

    .button {
        transition: background 0.3s ease;
        padding: 5px !important;
    }

    .button:hover {
        opacity: 0.85;
    }

    /* Button colors */
    .btn-excel {
        background: #28a745;
        color: white;
    }

    .btn-csv {
        background: #ffcc00;
        color: black;
    }

    .btn-pdf {
        background: #dc3545;
        color: white;
    }

    .btn-print {
        background: #007bff;
        color: white;
    }

    /* Icons styling */
    .fa {
        font-size: 16px;
    }

    /* Custom spinner using CSS */
    .custom-spinner {
        border: 6px solid #f3f3f3;
        /* Light grey */
        border-top: 6px solid #3498db;
        /* Blue color */
        border-left: 6px solid #3498db;
        /* Blue color */
        border-radius: 50%;
        width: 23px;
        height: 23px;
        animation: spin 1s linear infinite;
        margin-bottom: 5px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}


{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:admin-sitin_index' %}">Sit-in Management</a>
&rsaquo; <a href="{% url 'admin:finished_sitins_changelist' %}">View Sit-ins History</a>
&rsaquo; <a href="{% url 'admin:admin-export_all_sitins' %}">Generate Reports</a>
</div>
{% endblock %}

{% block content %}

<div id="content-main">
    <form id="exportForm">
        {% csrf_token %}
        <div class="card mb-2">
            <div class="card-body">
                <div class="row mb-2">
                    <label for="lab-room" class="required mr-2">Filter by lab room: </label>
                    <select name="lab-room" id="lab-room" class="vSelect">
                        <option selected>None</option>
                        {% for choice in lab_room_choices %}
                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="row mb-2">
                    <label for="purpose" class="required mr-2">Filter by sitin purpose: </label>
                    <select name="purpose" id="purpose" class="vSelect">
                        <option selected>None</option>
                        {% for choice in purpose_choices %}
                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="row mb-2">
                    <label for="level" class="required mr-2">Filter by year level: </label>
                    <select name="level" id="level" class="vSelect">
                        <option selected>None</option>
                        {% for choice in level_choices %}
                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div id="loading-spinner" class="custom-spinner" style="display: none;" role="status">
            <span class="sr-only">Loading...</span>
        </div>

        <div class="submit-row">
            <button type="button" class="button btn-excel" onclick="exportReport('xlsx')"><i
                    class="fas fa-file-excel"></i> Export to Excel</button>
            <button type="button" class="button btn-csv" onclick="exportReport('csv')"><i class="fas fa-file-csv"></i>
                Export to CSV</button>
            <button type="button" class="button btn-pdf" onclick="exportReport('pdf')"><i class="fas fa-file-pdf"></i>
                Export to PDF</button>
            <button type="button" class="button btn-print" onclick="exportReport('pdf', true)"><i class="fas fa-print"></i> Print</button>
        </div>
    </form>
</div>

<script>
    async function exportReport(type, isPrint) {
        // Get all filter values
        const labroom = document.getElementById('lab-room').value;
        const purpose = document.getElementById('purpose').value;
        const level = document.getElementById('level').value;
        
        if (!type) {
            RenderErrorDiv(document.getElementById('content-main'), { 
                "Validation Error": "Please select an export type"
            });
            return;
        }
    
        // Build URL
        let url = `/admin/backend/finishedsitins/export_all_sitins/${type}/`;
        
        // Add query parameters - all are optional
        const params = new URLSearchParams();
        if (labroom && labroom !== 'None') params.append('lab_room', labroom);
        if (purpose && purpose !== 'None') params.append('purpose', purpose);
        if (level && level !== 'None') params.append('level', level);
        
        if (params.toString()) {
            url += `?${params.toString()}`;
        }
    
        const spinner = document.getElementById('loading-spinner');
        try {
            spinner.style.display = 'block';
            const res = await fetch(url);
            
            if (res.ok) {
                const blob = await res.blob();
                
                if (isPrint) {
                    printDocument(URL.createObjectURL(blob));
                    return;
                }
                
                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                
                // Generate filename with available filters
                let filename = 'sitin_history';
                if (labroom && labroom !== 'None') filename += `_${labroom}`;
                if (purpose && purpose !== 'None') filename += `_${purpose}`;
                if (level && level !== 'None') filename += `_${level}`;
                filename += `.${type}`;
                
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } else {
                const error = await res.json();
                RenderErrorDiv(document.getElementById('content-main'), { 
                    "Export Error": error.error || "Failed to export data" 
                });
            }
        } catch (error) {
            console.error('Export error:', error);
            RenderErrorDiv(document.getElementById('content-main'), { 
                "Export Error": "Failed to connect to the server. Please try again." 
            });
        } finally {
            spinner.style.display = 'none';
        }
    }

    function printDocument(fileURL) {
        const newTab = window.open(fileURL, '_blank');
        if (newTab) {
            newTab.onload = () => newTab.print();
        } else {
            alert("Please allow pop-ups for this site to print the document.");
        }
    }

    function RenderErrorDiv(parentElement, data) {
        for (let field in data) {
            let errorDiv = document.createElement('div');
            let text = document.createElement('span');
            errorDiv.classList.add('custom-alerts', 'alert', 'alert-danger', 'mb-1', 'small', 'fade-in');
            text.textContent = `${field.toUpperCase()}: ${data[field]}`;
            errorDiv.appendChild(text);
            parentElement.insertAdjacentElement("beforebegin", errorDiv);
        }

        document.querySelectorAll('.custom-alerts').forEach(el => {
            setTimeout(() => el.remove(), 10000);
        });
    }

</script>

{% endblock %}