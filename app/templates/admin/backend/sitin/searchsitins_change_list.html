<!-- your_app/templates/admin/your_app/sitin/change_list.html -->
{% extends "admin/custom_change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrahead %}
{{ block.super }}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        function createPieChart(chartId, labels, data) {
            new Chart(document.getElementById(chartId), {
                type: "pie",
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            "rgba(255, 99, 132, 0.5)",
                            "rgba(54, 162, 235, 0.5)",
                            "rgba(255, 206, 86, 0.5)",
                            "rgba(75, 192, 192, 0.5)",
                            "rgba(153, 102, 255, 0.5)",
                            "rgba(255, 159, 64, 0.5)"
                        ],
                        borderColor: [
                            "rgba(255, 99, 132, 1)",
                            "rgba(54, 162, 235, 1)",
                            "rgba(255, 206, 86, 1)",
                            "rgba(75, 192, 192, 1)",
                            "rgba(153, 102, 255, 1)",
                            "rgba(255, 159, 64, 1)"
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "bottom"
                        }
                    }
                }
            });
        }

        // Data for Charts
        const programmingLanguageLabels = [{% for stat in programming_language_stats %}"{{ stat.programming_language }}",{% endfor %}];
        const programmingLanguageData = [{% for stat in programming_language_stats %}{{ stat.count }},{% endfor %}];

        const purposeLabels = [{% for stat in purpose_stats %}"{{ stat.purpose }}",{% endfor %}];
        const purposeData = [{% for stat in purpose_stats %}{{ stat.count }},{% endfor %}];

        const labRoomLabels = [{% for stat in lab_room_stats %}"{{ stat.lab_room }}",{% endfor %}];
        const labRoomData = [{% for stat in lab_room_stats %}{{ stat.count }},{% endfor %}];

        // Create Charts
        createPieChart("programmingLanguageChart", programmingLanguageLabels, programmingLanguageData);
        createPieChart("purposeChart", purposeLabels, purposeData);
        createPieChart("labRoomChart", labRoomLabels, labRoomData);
    });
</script>

<script>
    sitin_id = null;

    function showConfirmApproveModal(id) {
        sitin_id = id;
        let modal = new bootstrap.Modal(document.getElementById('confirmApproveModal'));
        modal.show();
    }

    document.getElementById("confirmApproveBtn").addEventListener("click", function () {
        ApproveSitin();
    });

    async function ApproveSitin() {
        console.log('called')
        if (sitin_id) {
            const data = new URLSearchParams();
            data.append("sitin_id", sitin_id);
            data.append("csrfmiddlewaretoken", "{{ csrf_token }}");

            const url = "{% url 'admin-approve-sitin' %}";
            const header = {
                'method': 'POST',
                'headers': {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                'body': data
            };

            try {
                const response = await fetch(url, header);
                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('alertMessages', JSON.stringify({ "Sit-in": "Student has been successfully approved." }));
                    window.location.href = '#';
                    window.location.reload();
                } else {
                    console.log('idk what went wrong bruh');
                    console.log(data);
                    RenderErrorDiv(parent, { "Sitin": "Failed to approve student." })
                }

            } catch (error) {
                console.log('error', error);
                RenderErrorDiv(parent, { "Sitin": "Cannot connect to the server. Please try again." })
            }
        }
    }

    const parent = document.querySelector("#main");

    function RenderSuccessDiv(parentElement, data) {
        for (let field in data) {
            let successDiv = document.createElement('div');
            let text = document.createElement('span');
            successDiv.classList.add('custom-alerts', 'alert', 'alert-success', 'mb-1', 'small', 'fade-in');
            text.textContent = `${field.toUpperCase()}: ${data[field]}`;
            successDiv.appendChild(text);
            parentElement.insertAdjacentElement("beforebegin", successDiv);
        }

        document.querySelectorAll('.custom-alerts').forEach(el => {
            setTimeout(() => el.remove(), 10000);
        });
    }

    function RenderErrorDiv(parentElement, data) {
        for (let field in data) {
            let errorDiv = document.createElement('div');
            let text = document.createElement('span');
            errorDiv.classList.add('custom-alerts', 'alert', 'alert-danger', 'mb-1', 'small', 'fade-in');
            text.textContent = `${field.toUpperCase()}: ${data[field]}`;
            errorDiv.appendChild(text);
            parentElement.insertAdjacentElement("beforebegin", errorDiv);
        }

        document.querySelectorAll('.custom-alerts').forEach(el => {
            setTimeout(() => el.remove(), 10000);
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const alertMessages = JSON.parse(localStorage.getItem('alertMessages'));
        // Define 'parent' as container to append success message in any html script.
        if (parent) {
            RenderSuccessDiv(parent, alertMessages);
        }

        if (alertMessages) {
            localStorage.removeItem('alertMessages');
        }
    });

</script>
{% endblock %}

{% block content %}

<style>
    .table-container {
        overflow-x: auto;
        /* Enable horizontal scrolling */
        width: 100%;
        /* Ensure the container takes full width */
        margin-bottom: 20px;
        /* Add some spacing between tables */
    }

    ;

    .table-container table {
        width: 100%;
        /* Ensure the table takes full width */
        border-collapse: collapse;
        /* Remove spacing between cells */
    }

    .table-container th,
    .table-container td {
        padding: 8px !important;
        /* Add padding to cells */
        text-align: left;
        /* Align text to the left */
        white-space: nowrap;
        /* Prevent text from wrapping */
    }

    .modal * {
        font-size: small;
    }
</style>

<!-- Bootstrap Confirmation Modal -->
<div class="modal fade" id="confirmApproveModal" tabindex="-1" aria-labelledby="confirmApproveModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmApproveLabel">Confirm Approval</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to approve this sit-in?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApproveBtn">Approve</button>
            </div>
        </div>
    </div>
</div>

<div id="content-main">
    <!-- For some reason, object-tools have actually been moved into content-main -->
    {% block object-tools %}
    {{ block.super }}
    {% endblock %}
    <div class="module{% if cl.has_filters %} filtered{% endif %}" id="changelist">
        <div class="changelist-form-container">
            {% block search %}{% search_form cl %}{% endblock %}
            {% block date_hierarchy %}{% if cl.date_hierarchy %}{% date_hierarchy cl %}{% endif %}{% endblock %}

            <!-- Table for All Sit-ins -->
            <h3>All Sit-ins</h3>
            <div class="results table-container">
                <table id="result_list_all">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Fullname</th>
                            <th>Purpose</th>
                            <th>Lab Room</th>
                            <!-- <th>Status</th> -->
                            <th>Approve Sitin?</th>
                            <th>Request Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sitin in cl.result_list %}
                        <tr class="{% cycle 'row1' 'row2' %}">
                            <td>{{ sitin.user.registration.idno }}</td>
                            <td>{{ sitin.user.registration.firstname }} {{ sitin.user.registration.lastname }}</td>
                            <td>{{ sitin.purpose }}</td>
                            <td>{{ sitin.lab_room }}</td>
                            <!-- <td>{{ sitin.status }}</td> -->
                            <td>
                                {% if sitin.status == "pending" %}
                                <button class="btn btn-success btn-sm shadow-sm animate-btn"
                                    onclick="showConfirmApproveModal('{{ sitin.id }}')">
                                    <i class="fas fa-check-circle"></i> Approve
                                </button>

                                {% else %}
                                already {{ sitin.status }}
                                {% endif %}
                            </td>
                            <td>{{ sitin.date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% block pagination %}{% pagination cl %}{% endblock %}
            <br>

            <h1>Sitin Tables</h1>
            <!-- Table for Pending Sit-ins -->
            <h3>Pending Sit-ins</h3>
            <div class="table-container">
                <table id="result_list_pending">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Fullname</th>
                            <th>Purpose</th>
                            <th>Lab Room</th>
                            <th>Status</th>
                            <th>Request Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sitin in pending_sitins %}
                        <tr class="{% cycle 'row1' 'row2' %}">
                            <td>{{ sitin.user.registration.idno }}</td>
                            <td>{{ sitin.user.registration.firstname }} {{ sitin.user.registration.lastname }}</td>
                            <td>{{ sitin.purpose }}</td>
                            <td>{{ sitin.lab_room }}</td>
                            <td>{{ sitin.status }}</td>
                            <td>{{ sitin.date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <br>
            <!-- Table for Current Sit-ins -->
            <h3>Current Sit-ins</h3>
            <div class="table-container">
                <table id="result_list_current">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Fullname</th>
                            <th>Purpose</th>
                            <th>Lab Room</th>
                            <th>Status</th>
                            <th>Time-in</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sitin in current_sitins %}
                        <tr class="{% cycle 'row1' 'row2' %}">
                            <td>{{ sitin.user.registration.idno }}</td>
                            <td>{{ sitin.user.registration.firstname }} {{ sitin.user.registration.lastname }}</td>
                            <td>{{ sitin.purpose }}</td>
                            <td>{{ sitin.lab_room }}</td>
                            <td>{{ sitin.status }}</td>
                            <td>{{ sitin.sitin_date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <br>
            <!-- Table for Finished Sit-ins -->
            <h3>Timed-out Sit-ins</h3>
            <div class="table-container">
                <table id="result_list_finished">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Fullname</th>
                            <th>Purpose</th>
                            <th>Lab Room</th>
                            <th>Status</th>
                            <th>Time-out</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sitin in finished_sitins %}
                        <tr class="{% cycle 'row1' 'row2' %}">
                            <td>{{ sitin.id }}</td>
                            <td>{{ sitin.user.id }}</td>
                            <td>{{ sitin.user.registration.firstname }} {{ sitin.user.registration.lastname }}</td>
                            <td>{{ sitin.purpose }}</td>
                            <td>{{ sitin.lab_room }}</td>
                            <td>{{ sitin.status }}</td>
                            <td>{{ sitin.logout_date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% block filters %}
        {{ block.super }}
        {% endblock %}
    </div>
</div>

<h3>Sitin Statistics</h3>
<div class="container">

    <div>
        <h4>Programming Language Usage</h4>
        <div class="chart-container">
            <canvas id="programmingLanguageChart"></canvas>
        </div>
    </div>

    <div>
        <h4>Purposes</h4>
        <div class="chart-container">
            <canvas id="purposeChart"></canvas>
        </div>
    </div>

    <div>
        <h4>Lab Rooms Used</h4>
        <div class="chart-container">
            <canvas id="labRoomChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        /* Flexible columns */
        gap: 20px;
        /* Space between charts */
        justify-content: center;
        /* Center align items */
        padding: 20px;
    }

    h4 {
        text-align: center;
    }

    .chart-container {
        width: 400px;
        /* Default size */
        max-width: 100%;
        margin: 5px auto;
        /* Center align */
    }

    @media (max-width: 992px) {
        .chart-container {
            width: 200px;
            /* Set width to 80% for medium screens */
        }
    }

    /* Small Screens (Mobile Devices) */
    @media (max-width: 576px) {
        .chart-container {
            width: 150px;
            /* Set width to 95% for small screens */
        }
    }
</style>
{% endblock %}